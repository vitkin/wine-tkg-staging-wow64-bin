name: Auto-Update Wine TkG

on:
  schedule:
    - cron: '0 4 * * *' # Run daily at 4 AM UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  update-pacakge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for updates
        id: check
        run: |
          chmod +x update-package.sh
          ./update-package.sh latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify if files changed
        id: verify_diff
        run: |
          if git diff --quiet wine-tkg-staging-wow64-bin.pacscript; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "New version detected!"
          fi

      - name: Commit and Push changes
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Extract new version from file
          NEW_VER=$(grep pkgver wine-tkg-staging-wow64-bin.pacscript | head -n1 | cut -d'"' -f2)
          
          git add wine-tkg-staging-wow64-bin.pacscript
          git commit -m "update: wine-tkg-staging to version ${NEW_VER}"
          git push
